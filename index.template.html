<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>OpenTimeline Universe Example</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
      
        padding: 0;
        margin: 0;
        background-color: #000000;
      }

      body {
        opacity: 1;
        transition: ease-in-out opacity 2s;
        &.loading {
          opacity: 0;
          visibility: hidden;
        }
      }

      svg .node {
        scroll-margin: 50vh 50vw;

        &:focus,
        &:focus-visible,
        &:has(:focus) {
          outline: 5px dashed #ffffff;
        }
      }
    </style>
  </head>
  <body class="loading">SVG</body>
  <script>
    const nodes = [...document.querySelectorAll(".node").values()];
    const ids = nodes.map(_ => _.id).sort();
    const idSet = new Set(ids);
    const timelineIds = new Set(nodes.map(_ => [..._.classList.values()].filter(c=>c.startsWith("t"))[0]).sort());
    const timelineNodes = new Map([...timelineIds.values()].map(_=>[_,[...document.querySelectorAll(`.node.${_}`).values()].map(node=>node.id).sort()]));
    const nodeTimelines = new Map([...timelineIds.values()].flatMap(_=>[...document.querySelectorAll(`.node.${_}`).values()].map(node=>node.id).sort().map(id=>[id,_])));
    let idFocused = idSet.has(window.location.hash.replace(/^#/,"")) ? window.location.hash.replace(/^#/,"") : undefined;
    let idFocusedIndex = idFocused !== undefined ? ids.indexOf(idFocused) : -1;

    const focusNode = (id) => {
      const anchor = `#${id}`;
      const node = document.querySelector(anchor);

      window.history.replaceState({id}, "", window.location.toString().replace(/(#.*)|$/, anchor));
      node.focus({preventScroll: true});

      let left = window.pageXOffset + node.getBoundingClientRect().left;
      let top = window.pageYOffset + node.getBoundingClientRect().top;

      left = left - document.documentElement.clientWidth / 2;
      top = top - document.documentElement.clientHeight / 2;

      window.scrollTo({top, behavior: "smooth", left});
    };

    console.info("Timline loaded. SVG should fade in now.");
    document.body.classList.remove("loading");

    if (-1 < idFocusedIndex) {
      const node = document.querySelector(`#${idFocused}`);
      const timeline = nodeTimelines.get(node.id);
      console.info(`Selecting node #${idFocused} of timeline ${timeline} from location anchor.`);
      focusNode(idFocused);
    }

    document.addEventListener("keyup", (event) => {
      console.debug(`keyup: key:${event.key} code:${event.code}`);

      const focusedNode = document.querySelector(":focus");
      if (focusedNode && focusedNode.id !== idFocused && idSet.has(focusedNode.id)) {
        idFocused = focusedNode.id;
        idFocusedIndex = ids.indexOf(focusedNode.id);
      }

      let updateNavigation = true;
      const scrollTo = (slice) => {
        const step = document.body.scrollHeight / 10;
        const top = step * slice;
        console.log(`Scrolling to ${top}`);
        window.scrollTo({top, behavior: "smooth"});
        updateNavigation = false;
      }

      switch (event.code) {
        case "Digit0":
          scrollTo(0);
          break;
        case "Digit1":
          scrollTo(1);
          break;
        case "Digit2":
          scrollTo(2);
          break;
        case "Digit3":
          scrollTo(3);
          break;
        case "Digit4":
          scrollTo(4);
          break;
        case "Digit5":
          scrollTo(5);
          break;
        case "Digit6":
          scrollTo(6);
          break;
        case "Digit7":
          scrollTo(7);
          break;
        case "Digit8":
          scrollTo(8);
          break;
        case "Digit9":
          scrollTo(9);
          break;

        case "Numpad5":
          break;

        case "Numpad7":
          idFocusedIndex = 0;
          idFocusedIndex = Math.min(Math.max(0, idFocusedIndex), ids.length - 1);
          idFocused = ids[idFocusedIndex];
          break;
        case "Numpad8":
          --idFocusedIndex;
          idFocusedIndex = Math.min(Math.max(0, idFocusedIndex), ids.length - 1);
          idFocused = ids[idFocusedIndex];
          break;
        case "Numpad9":
          idFocusedIndex -= 10;
          idFocusedIndex = Math.min(Math.max(0, idFocusedIndex), ids.length - 1);
          idFocused = ids[idFocusedIndex];
          break;

        case "Numpad1":
        idFocusedIndex = ids.length - 1;
          idFocusedIndex = Math.min(Math.max(0, idFocusedIndex), ids.length - 1);
          idFocused = ids[idFocusedIndex];
          break;
        case "Numpad2":
          ++idFocusedIndex;
          idFocusedIndex = Math.min(Math.max(0, idFocusedIndex), ids.length - 1);
          idFocused = ids[idFocusedIndex];
          break;
        case "Numpad3":
          idFocusedIndex += 10;
          idFocusedIndex = Math.min(Math.max(0, idFocusedIndex), ids.length - 1);
          idFocused = ids[idFocusedIndex];
          break;

        default:
          updateNavigation = false;
          break;
      }

      if (!updateNavigation) {
        return;
      }

      event.preventDefault();
      focusNode(idFocused);
    });
  </script>
</html>
